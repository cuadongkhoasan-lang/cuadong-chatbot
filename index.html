<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trợ lý tư vấn gói sinh Cửa Đông</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React CDN + Gemini -->
    <script type="importmap">
      {
        "imports": {
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "react": "https://esm.sh/react@18.2.0",
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect, useRef } from "react";
      import ReactDOM from "react-dom/client";
      import { GoogleGenerativeAI } from "@google/generative-ai";

      // ✅ Logo từ file nội bộ (bạn tải lên cùng thư mục)
      const logoUrl = "./logo.png";

      // ✅ CẤU HÌNH GEMINI (API KEY bạn yêu cầu)
      const apiKey = "AIzaSyCL2Doc6pHGVFewYxYulHM91GV0WZsKYpM";
      const genAI = new GoogleGenerativeAI(apiKey);
      const model = genAI.getGenerativeModel({ model: "gemini-pro" });

      // ✅ Load dữ liệu nội bộ (tạo knowledgeBase phẳng)
      let knowledgeBase = [];

      fetch("data.json")
        .then((res) => res.json())
        .then((data) => {
          knowledgeBase = [
            data.hospital.name,
            data.hospital.address,
            data.hospital.hotline,
            data.hospital.website,

            ...data.packages.flatMap((pkg) => [
              pkg.package_name,
              pkg.room_type,
              ...Object.entries(pkg.prices).map(
                ([k, v]) => `${pkg.package_name} - ${k}: ${v}`
              ),
              ...pkg.included.map(
                (item) => `${pkg.package_name} - dịch vụ bao gồm: ${item}`
              )
            ]),

            ...data.extra_fees,
            ...data.promotions,
            ...data.refund_policy
          ];
        });

      // ✅ Search đơn giản theo từ khóa
      function searchKnowledge(question) {
        question = question.toLowerCase();
        return knowledgeBase.filter((line) =>
          line.toLowerCase().includes(question)
        );
      }

      // ✅ Hàm gọi AI
      const getBotResponse = async (message) => {
        const matched = searchKnowledge(message);

        if (matched.length === 0) {
          return "Trong dữ liệu gói sinh hiện tại chưa có thông tin này. Vui lòng liên hệ hotline 0238.626.9999.";
        }

        const prompt = `
          Bạn chỉ được phép trả lời dựa trên nội dung sau:
          ----
          ${matched.join("\n")}
          ----
          Không được dùng kiến thức ngoài dữ liệu.
          Nếu không có câu trả lời trong dữ liệu → trả lời: "Trong dữ liệu gói sinh hiện tại chưa có thông tin này. Vui lòng liên hệ hotline 0238.626.9999."
          Câu hỏi của khách: ${message}
        `;

        try {
          const result = await model.generateContent(prompt);
          return result.response.text();
        } catch (error) {
          console.error(error);
          return "Lỗi khi kết nối AI. Vui lòng thử lại.";
        }
      };

      // ========================= UI =========================

      const Sender = { USER: 0, BOT: 1 };

      const ChatBubble = ({ message }) => {
        const isUser = message.sender === Sender.USER;

        if (isUser) {
          return React.createElement(
            "div",
            { className: "flex justify-end" },
            React.createElement(
              "div",
              { className: "bg-blue-700 text-white p-3 rounded-lg max-w-lg shadow" },
              message.text
            )
          );
        }

        return React.createElement(
          "div",
          { className: "flex items-start space-x-3" },
          React.createElement("img", {
            src: logoUrl,
            className: "h-8 w-8 rounded-full bg-white p-1"
          }),
          React.createElement(
            "div",
            { className: "bg-gray-100 p-3 rounded-lg max-w-lg shadow" },
            message.text
          )
        );
      };

      const MessageInput = ({ onSend, isLoading }) => {
        const [value, setValue] = useState("");

        const submit = (e) => {
          e.preventDefault();
          if (value.trim()) {
            onSend(value);
            setValue("");
          }
        };

        return React.createElement(
          "form",
          { onSubmit: submit, className: "flex items-center space-x-3" },
          React.createElement("input", {
            type: "text",
            value,
            onChange: (e) => setValue(e.target.value),
            placeholder: "Nhập câu hỏi...",
            disabled: isLoading,
            className:
              "flex-1 px-4 py-2 bg-gray-100 border border-gray-300 rounded-full"
          }),
          React.createElement(
            "button",
            {
              type: "submit",
              disabled: isLoading || !value.trim(),
              className:
                "p-3 bg-blue-700 text-white rounded-full disabled:bg-gray-400"
            },
            "Gửi"
          )
        );
      };

      const Header = () =>
        React.createElement(
          "header",
          { className: "bg-blue-800 shadow-md w-full" },
          React.createElement(
            "div",
            { className: "max-w-7xl mx-auto px-4" },
            React.createElement(
              "div",
              { className: "flex items-center h-16 space-x-3" },
              React.createElement("img", {
                src: logoUrl,
                className: "h-10 w-10 rounded-full bg-white p-1"
              }),
              React.createElement(
                "h1",
                { className: "text-xl font-bold text-white" },
                "Trợ lý tư vấn gói sinh Cửa Đông"
              )
            )
          )
        );

      const App = () => {
        const [messages, setMessages] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const endRef = useRef(null);

        useEffect(() => {
          endRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);

        useEffect(() => {
          setMessages([
            {
              id: Date.now(),
              text:
                "Xin chào! Tôi là Trợ lý tư vấn gói sinh của Bệnh viện Cửa Đông. Tôi có thể hỗ trợ gì cho bạn?",
              sender: Sender.BOT
            }
          ]);
        }, []);

        const send = async (text) => {
          const userMsg = { id: Date.now(), text, sender: Sender.USER };
          setMessages((prev) => [...prev, userMsg]);

          setIsLoading(true);

          const botText = await getBotResponse(text);
          const botMsg = { id: Date.now() + 1, text: botText, sender: Sender.BOT };

          setMessages((prev) => [...prev, botMsg]);
          setIsLoading(false);
        };

        return React.createElement(
          "div",
          { className: "flex flex-col h-screen bg-blue-50" },
          React.createElement(Header),
          React.createElement(
            "main",
            { className: "flex-1 overflow-y-auto p-4 space-y-6" },
            messages.map((m) =>
              React.createElement(ChatBubble, { key: m.id, message: m })
            ),
            React.createElement("div", { ref: endRef })
          ),
          React.createElement(
            "div",
            { className: "p-4 bg-white border-t" },
            React.createElement(MessageInput, { onSend: send, isLoading })
          )
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(
        React.createElement(App)
      );
    </script>
  </body>
</html>
