<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ l√Ω t∆∞ v·∫•n g√≥i sinh C·ª≠a ƒê√¥ng</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
      {
        "imports": {
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "react": "https://esm.sh/react@18.2.0",
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect, useRef } from "react";
      import ReactDOM from "react-dom/client";
      import { GoogleGenerativeAI } from "@google/generative-ai";

      const logoUrl = "./logo.png";

      // ‚úÖ GEMINI API
      const apiKey = "AIzaSyCL2Doc6pHGVFewYxYulHM91GV0WZsKYpM";
      const genAI = new GoogleGenerativeAI(apiKey);
      const model = genAI.getGenerativeModel({ model: "gemini-pro" });

      // ‚úÖ Load JSON
      let knowledgeBase = [];

      fetch("data.json")
        .then((res) => res.json())
        .then((data) => {
          knowledgeBase = [
            data.hospital.name,
            data.hospital.address,
            data.hospital.hotline,
            data.hospital.website,

            ...data.packages.flatMap((pkg) => [
              pkg.package_name,
              pkg.room_type,
              ...Object.entries(pkg.prices).map(
                ([k, v]) => `${pkg.package_name} - ${k}: ${v}`
              ),
              ...pkg.included.map(
                (item) => `${pkg.package_name} - bao g·ªìm: ${item}`
              )
            ]),

            ...data.extra_fees,
            ...data.promotions,
            ...data.refund_policy
          ];
        });

      // ‚úÖ Search th√¥ng minh h∆°n
      function searchKnowledge(question) {
        const tokens = question.toLowerCase().split(/\s+/).filter(t => t.length > 1);

        return knowledgeBase.filter(line => {
          const lower = line.toLowerCase();
          return tokens.some(token => lower.includes(token));
        });
      }

      // ‚úÖ LU√îN g·ªçi Gemini ‚Üí JSON ch·ªâ l√† context
      const getBotResponse = async (message) => {
        const matched = searchKnowledge(message);

        const context =
          matched.length > 0
            ? matched.join("\n")
            : "KH√îNG C√ì D·ªÆ LI·ªÜU PH√ô H·ª¢P TRONG JSON.\nH√£y tr·∫£ v·ªÅ: Trong d·ªØ li·ªáu g√≥i sinh hi·ªán t·∫°i ch∆∞a c√≥ th√¥ng tin n√†y. Vui l√≤ng li√™n h·ªá hotline 0238.626.9999.";

        const prompt = `
B·∫°n l√† tr·ª£ l√Ω t∆∞ v·∫•n g√≥i sinh c·ªßa B·ªánh vi·ªán C·ª≠a ƒê√¥ng.

B·∫°n CH·ªà ƒë∆∞·ª£c tr·∫£ l·ªùi d·ª±a tr√™n d·ªØ li·ªáu d∆∞·ªõi ƒë√¢y:

--------
${context}
--------

N·∫øu d·ªØ li·ªáu ch·ª©a c√¢u "KH√îNG C√ì D·ªÆ LI·ªÜU PH√ô H·ª¢P TRONG JSON",
b·∫°n B·∫ÆT BU·ªòC tr·∫£ v·ªÅ ƒë√∫ng c√¢u sau:
"Trong d·ªØ li·ªáu g√≥i sinh hi·ªán t·∫°i ch∆∞a c√≥ th√¥ng tin n√†y. Vui l√≤ng li√™n h·ªá hotline 0238.626.9999."

C√¢u h·ªèi c·ªßa kh√°ch: "${message}"
        `;

        try {
          const result = await model.generateContent(prompt);
          return result.response.text();
        } catch (error) {
          return "L·ªói k·∫øt n·ªëi AI.";
        }
      };

      // ‚úÖ UI
      const Sender = { USER: 0, BOT: 1 };

      const ChatBubble = ({ message }) => {
        const isUser = message.sender === Sender.USER;

        if (isUser) {
          return (
            <div className="flex justify-end">
              <div className="bg-blue-700 text-white p-3 rounded-lg max-w-lg shadow">
                {message.text}
              </div>
            </div>
          );
        }

        return (
          <div className="flex items-start space-x-3">
            <img src={logoUrl} className="h-8 w-8 rounded-full bg-white p-1" />
            <div className="bg-gray-100 p-3 rounded-lg max-w-lg shadow">
              {message.text}
            </div>
          </div>
        );
      };

      const MessageInput = ({ onSend, isLoading }) => {
        const [value, setValue] = useState("");

        const submit = (e) => {
          e.preventDefault();
          if (value.trim()) onSend(value);
          setValue("");
        };

        return (
          <form onSubmit={submit} className="flex items-center space-x-3">
            <input
              type="text"
              value={value}
              onChange={(e) => setValue(e.target.value)}
              placeholder="Nh·∫≠p c√¢u h·ªèi..."
              disabled = {isLoading}
              className="flex-1 px-4 py-2 bg-gray-100 border border-gray-300 rounded-full"
            />
            <button
              type="submit"
              disabled={isLoading || !value.trim()}
              className="p-3 bg-blue-700 text-white rounded-full disabled:bg-gray-400"
            >
              G·ª≠i
            </button>
          </form>
        );
      };

      const Header = () => (
        <header className="bg-blue-800 shadow-md w-full">
          <div className="max-w-7xl mx-auto px-4">
            <div className="flex items-center h-16 space-x-3">
              <img src={logoUrl} className="h-10 w-10 rounded-full bg-white p-1" />
              <h1 className="text-xl font-bold text-white">
                Tr·ª£ l√Ω t∆∞ v·∫•n g√≥i sinh C·ª≠a ƒê√¥ng
              </h1>
            </div>
          </div>
        </header>
      );

      const App = () => {
        const [messages, setMessages] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const endRef = useRef(null);

        useEffect(() => {
          endRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);

        useEffect(() => {
          setMessages([
            {
              id: Date.now(),
              text: "Xin ch√†o! T√¥i l√† Tr·ª£ l√Ω t∆∞ v·∫•n g√≥i sinh c·ªßa B·ªánh vi·ªán C·ª≠a ƒê√¥ng. T√¥i c√≥ th·ªÉ h·ªó tr·ª£ g√¨ cho b·∫°n?",
              sender: Sender.BOT
            }
          ]);
        }, []);

        const send = async (text) => {
          const userMsg = { id: Date.now(), text, sender: Sender.USER };
          setMessages((prev) => [...prev, userMsg]);
          setIsLoading(true);

          const botText = await getBotResponse(text);
          const botMsg = { id: Date.now() + 1, text: botText, sender: Sender.BOT };

          setMessages((prev) => [...prev, botMsg]);
          setIsLoading(false);
        };

        return (
          <div className="flex flex-col h-screen bg-blue-50">
            <Header />
            <main className="flex-1 overflow-y-auto p-4 space-y-6">
              {messages.map((m) => (
                <ChatBubble key={m.id} message={m} />
              ))}
              <div ref={endRef} />
            </main>
            <div className="p-4 bg-white border-t">
              <MessageInput onSend={send} isLoading={isLoading} />
            </div>

            {/* ‚úÖ Floating Hotline Button */}
            <a
              href="tel:02386269999"
              className="fixed bottom-5 right-5 bg-red-600 text-white px-5 py-3 rounded-full shadow-xl font-bold text-sm hover:bg-red-700 transition"
            >
              üìû G·ªçi 0238.626.9999
            </a>

          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
